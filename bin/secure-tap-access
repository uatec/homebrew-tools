#!/bin/bash

SERVICE_NAME="uatec-homebrew-tools-github-token"

if [[ "$1" == "--help" ]]; then
  echo "Usage: secure-tap-access"
  echo ""
  echo "Prompts for a GitHub Personal Access Token and saves it to the macOS Keychain"
  echo "for use with the uatec/homebrew-tools tap."
  exit 0
fi

# Helper function to check OS
is_macos() {
  [[ "$OSTYPE" == "darwin"* ]]
}

# 1. Get Hostname
HOSTNAME=$(hostname)

# 2. Construct URL with hostname in description
URL="https://github.com/settings/tokens/new?description=Homebrew%20Tools%20Tap%20(${HOSTNAME})&scopes=repo"

echo "This script will save your GitHub Personal Access Token for the uatec/homebrew-tools tap."
echo "Service Name: $SERVICE_NAME"
echo ""
echo "Please open the following URL in your browser to create a new token:"
echo "---------------------------------------------------------------------"
echo "$URL"
echo "---------------------------------------------------------------------"
echo "Ensure the 'repo' scope is selected."
echo "IMPORTANT: Set the 'Expiration' to '1 year' (or your preferred duration)."
echo ""

echo -n "Enter your GitHub Personal Access Token: "
read -s TOKEN
echo ""

if [ -z "$TOKEN" ]; then
  echo "Error: Token cannot be empty."
  exit 1
fi

if is_macos; then
  # macOS: Save to Keychain
  security add-generic-password -a "$USER" -s "$SERVICE_NAME" -w "$TOKEN" -U
  if [ $? -eq 0 ]; then
    echo "✅ Token saved successfully to macOS Keychain!"
  else
    echo "❌ Failed to save token to Keychain."
    exit 1
  fi
else
  # Linux (or other): Save to file
  CONFIG_DIR="$HOME/.config/uatec-homebrew-tools"
  TOKEN_FILE="$CONFIG_DIR/token"

  mkdir -p "$CONFIG_DIR"
  echo "$TOKEN" > "$TOKEN_FILE"
  chmod 600 "$TOKEN_FILE"

  if [ $? -eq 0 ]; then
    echo "✅ Token saved to $TOKEN_FILE"
  else
    echo "❌ Failed to save token to file."
    exit 1
  fi
fi
